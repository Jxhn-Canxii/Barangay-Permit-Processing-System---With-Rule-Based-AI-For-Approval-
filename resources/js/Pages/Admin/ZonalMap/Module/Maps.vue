<template>
  <div id="map" class="map-container"></div>
</template>

<script setup>
import { onMounted } from 'vue';
import L from 'leaflet';
import axios from 'axios';
import { convertWebMercatorToLatLng } from "@/Utility/Formatter.js";
// Custom Icon for Landmarks
const landmarkIcon = L.icon({
  iconUrl: 'https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.7.1/images/marker-icon.png', // Ensure this URL is accessible
  iconSize: [25, 41], 
  iconAnchor: [12, 41], 
  popupAnchor: [1, -34], 
  shadowUrl: 'https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.7.1/images/marker-shadow.png',
  shadowSize: [41, 41]
});


onMounted(async () => {
  //"coordinates": [ [ [ [ 13473057.760408407077193, 1657632.022554622031748 ], [ 13473059.519256360828876, 1657613.802200068719685 ], [ 13473127.836027862504125, 1657608.461555378744379 ], [ 13473150.522940082475543, 1657644.280728586483747 ], [ 13473307.438894305378199, 1657546.203994570299983 ], [ 13473318.871406011283398, 1657545.847185183083639 ], [ 13473384.215947104617953, 1657546.917613360565156 ], [ 13473397.774661082774401, 1657540.840344312367961 ], [ 13473409.696978548541665, 1657531.275554530322552 ], [ 13473418.658197557553649, 1657501.568330572918057 ], [ 13473420.82892762683332, 1657437.814743949100375 ], [ 13473415.140501648187637, 1657419.974357848521322 ], [ 13473412.769396493211389, 1657399.175936645129696 ], [ 13473420.884587373584509, 1657387.527907507726923 ], [ 13473438.217032089829445, 1657400.119749519042671 ], [ 13473445.898076953366399, 1657406.691910884808749 ], [ 13473478.971097668632865, 1657431.691461612936109 ], [ 13473501.658009894192219, 1657471.112995289964601 ], [ 13473537.491753978654742, 1657469.915960947284475 ], [ 13473558.987547649070621, 1657463.942300030728802 ], [ 13473575.707735169678926, 1657449.612425595987588 ], [ 13473585.359135020524263, 1657424.635876863496378 ], [ 13473589.400032535195351, 1657415.934375402517617 ], [ 13473650.180474508553743, 1657416.060984528856352 ], [ 13473641.631137616932392, 1657559.76275505614467 ], [ 13473645.371472507715225, 1657564.57392989215441 ], [ 13473668.136308372020721, 1657602.050481250276789 ], [ 13473683.665377337485552, 1657620.857838006922975 ], [ 13473702.556294927373528, 1657653.983681801706553 ], [ 13473811.760715395212173, 1657663.410397949395701 ], [ 13473828.903916979208589, 1657632.344835175899789 ], [ 13473838.900407250970602, 1657617.266713718650863 ], [ 13473866.841599438339472, 1657624.874833412934095 ], [ 13473889.060969803482294, 1657630.917592756450176 ], [ 13473912.515986513346434, 1657665.931095541920513 ], [ 13473958.490936210379004, 1657673.389599488349631 ], [ 13473991.185470657423139, 1657684.600379654206336 ], [ 13474003.720045320689678, 1657676.980731809511781 ], [ 13474050.173668825998902, 1657702.671154941665009 ], [ 13474081.487841587513685, 1657739.837140695657581 ], [ 13474065.969904569908977, 1657754.454932772554457 ], [ 13474029.256736509501934, 1657751.393252782756463 ], [ 13474030.826341329142451, 1657771.616461741738021 ], [ 13474029.178812863305211, 1657814.410989537835121 ], [ 13474024.926408316940069, 1657828.810132973594591 ], [ 13474019.549676910042763, 1657841.943171882769093 ], [ 13473994.625242922455072, 1657930.179876241600141 ], [ 13473970.30193418264389, 1657924.965775900986046 ], [ 13473951.177245665341616, 1657923.757209751289338 ], [ 13473970.736080195754766, 1657988.628518904326484 ], [ 13473978.984854465350509, 1657999.966052008792758 ], [ 13473997.920299850404263, 1658003.752904308727011 ], [ 13474000.636495426297188, 1658025.461132475873455 ], [ 13473991.49716523103416, 1658081.435298452852294 ], [ 13473987.311552375555038, 1658086.637921087676659 ], [ 13473933.310467394068837, 1658147.929961460875347 ], [ 13473920.631177389994264, 1658167.002463542856276 ], [ 13473805.42663637176156, 1658221.296442957827821 ], [ 13473929.815035382285714, 1658279.964459965471178 ], [ 13474019.649864453822374, 1658379.862699932651594 ], [ 13473990.239254983142018, 1658429.990380108123645 ], [ 13473981.667654193937778, 1658506.868364866822958 ], [ 13473896.998049495741725, 1658542.88449838059023 ], [ 13473872.273990590125322, 1658565.962936467956752 ], [ 13473847.572195583954453, 1658568.909611388342455 ], [ 13473851.70214869081974, 1658586.8313877962064 ], [ 13473858.325658395886421, 1658591.159320306498557 ], [ 13473887.836455402895808, 1658625.161241599125788 ], [ 13473924.638679061084986, 1658626.979896779404953 ], [ 13473901.384037431329489, 1658652.233894363977015 ], [ 13473953.103072855621576, 1658664.906944668386132 ], [ 13473948.082563819363713, 1658773.531708494992927 ], [ 13474048.169917993247509, 1658772.426696342416108 ], [ 13474048.281237484887242, 1658995.755246249726042 ], [ 13474047.134646728634834, 1659220.328946312423795 ], [ 13474024.447734504938126, 1659221.008080491330475 ], [ 13473989.716053379699588, 1659249.911587767535821 ], [ 13473945.332972398027778, 1659288.012239677133039 ], [ 13473694.630347182974219, 1659030.563462487887591 ], [ 13473092.113603264093399, 1658411.826997852185741 ], [ 13473106.473817575722933, 1658375.442720999242738 ], [ 13473076.495478706434369, 1658316.855052999220788 ], [ 13473061.723382275551558, 1658296.26307409722358 ], [ 13473167.888780646026134, 1658294.306319016264752 ], [ 13473237.496858239173889, 1658267.89014036511071 ], [ 13473225.151526711881161, 1658219.604430377017707 ], [ 13473162.601104835048318, 1658191.369706674944609 ], [ 13473186.390080017969012, 1658173.14894587919116 ], [ 13473222.513254780322313, 1658148.551515312865376 ], [ 13473235.726878337562084, 1658123.044799498282373 ], [ 13473218.984426921233535, 1658080.226724765263498 ], [ 13473211.937903152778745, 1658042.876071409322321 ], [ 13473203.132531430572271, 1657959.070385626517236 ], [ 13473165.250508714467287, 1657918.980496491538361 ], [ 13473080.669959612190723, 1657826.059216842288151 ], [ 13473097.401279075071216, 1657797.824936077930033 ], [ 13473100.05068296007812, 1657707.631987887201831 ], [ 13473057.760408407077193, 1657632.022554622031748 ] ] ] ] } }

  const brgySanAgustin = {
    "type": "Feature",
    "properties": {
      "name": "San Agustin, Quezon City"
    },
    "geometry": {
      "type": "MultiPolygon",
      "coordinates": [
        [
          [
            [121.06915, 14.68450], [121.06917, 14.68431], [121.06984, 14.68426],
            [121.07007, 14.68462], [121.07165, 14.68372], [121.07176, 14.68371],
            [121.07242, 14.68372], [121.07256, 14.68366], [121.07268, 14.68357],
            [121.07277, 14.68328], [121.07279, 14.68265], [121.07274, 14.68247],
            [121.07272, 14.68226], [121.07280, 14.68215], [121.07298, 14.68227],
            [121.07306, 14.68233], [121.07339, 14.68258], [121.07362, 14.68298],
            [121.07398, 14.68296], [121.07419, 14.68290], [121.07436, 14.68276],
            [121.07446, 14.68251], [121.07450, 14.68242], [121.07512, 14.68243],
            [121.07503, 14.68387], [121.07507, 14.68392], [121.07530, 14.68430],
            [121.07545, 14.68449], [121.07564, 14.68482], [121.07673, 14.68492],
            [121.07690, 14.68461], [121.07700, 14.68446], [121.07728, 14.68453],
            [121.07750, 14.68459], [121.07776, 14.68494], [121.07822, 14.68501],
            [121.07855, 14.68512], [121.07868, 14.68504], [121.07915, 14.68529],
            [121.07947, 14.68566], [121.07932, 14.68581], [121.07896, 14.68578],
            [121.07897, 14.68598], [121.07896, 14.68641], [121.07891, 14.68655],
            [121.07884, 14.68668], [121.07859, 14.68757], [121.07835, 14.68752],
            [121.07816, 14.68750], [121.07835, 14.68815], [121.07843, 14.68827],
            [121.07862, 14.68830], [121.07865, 14.68852], [121.07856, 14.68908],
            [121.07852, 14.68913], [121.07798, 14.68983], [121.07785, 14.68999],
            [121.07670, 14.69054], [121.07784, 14.69112], [121.07874, 14.69212],
            [121.07845, 14.69262], [121.07836, 14.69340], [121.07751, 14.69376],
            [121.07726, 14.69400], [121.07701, 14.69403], [121.07705, 14.69421],
            [121.07712, 14.69426], [121.07741, 14.69460], [121.07778, 14.69461],
            [121.07755, 14.69487], [121.07807, 14.69499], [121.07802, 14.69608],
            [121.07902, 14.69607], [121.07903, 14.69830], [121.07902, 14.70053],
            [121.07880, 14.70054], [121.07845, 14.70082], [121.07801, 14.70121],
            [121.07551, 14.69861], [121.07061, 14.69063], [121.07075, 14.69027],
            [121.07045, 14.68968], [121.07030, 14.68947], [121.07126, 14.68945],
            [121.07196, 14.68918], [121.07184, 14.68870], [121.07131, 14.68841],
            [121.07155, 14.68823], [121.07188, 14.68798], [121.07201, 14.68753],
            [121.07188, 14.68710], [121.07180, 14.68672], [121.07169, 14.68578],
            [121.07134, 14.68538], [121.07049, 14.68486], [121.07066, 14.68457],
            [121.07069, 14.68366], [121.06915, 14.68450]
          ]
        ]
      ]
    }
  };

  // Initialize the map (Ensure map is properly initialized)
  const map = L.map('map').setView([121.07357, 14.68908], 16); // Center map on an initial point

  // Add tile layer (required for map background)
  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      attribution: '&copy; OpenStreetMap contributors'
  }).addTo(map);

  // Extract the correct polygon coordinates (first set in MultiPolygon)
  const brgyCoordinates = brgySanAgustin.geometry.coordinates[0][0].map(coord => [coord[1], coord[0]]);

  // Create polygon
  const brgyArea = L.polygon(brgyCoordinates, {
      color: "red",
      fillColor: "#ff4d4d",
      fillOpacity: 0.5
  }).bindPopup("<strong>San Agustin, 5th District, Quezon City, Eastern Manila District, Metro Manila, 1117, Philippines</strong>").addTo(map);

  // Adjust map to fit bounds of polygon
  map.fitBounds(brgyArea.getBounds());

  // Fetch landmarks from API
  try {
    const response = await axios.get(route('landmarks.list.all'));
    const landmarks = response.data.landmarks;
    console.log("Fetched landmarks:", landmarks);

    landmarks.forEach(landmark => {
      if (landmark.latitude && landmark.longitude) {
        const mercatorPoints = convertWebMercatorToLatLng(landmark.latitude, landmark.longitude);

        // L.marker(mercatorPoints, { icon: landmarkIcon }) // Use custom icon
        L.marker(mercatorPoints) // Use defualt icon
          .addTo(map)
          .bindPopup(`<strong>${landmark.name}</strong><br>${landmark.building_type ?? 'Not available'}<br><br>${landmark.description ?? 'No description'}`);
      }
    });

  } catch (error) {
    console.error("Error fetching landmarks:", error);
  }

  window.addEventListener('resize', () => {
    setTimeout(() => {
      map.invalidateSize();
    }, 400);
  });

});
</script>

<style scoped>
#map {
  height: 100vh;
  width: 100%;
}
</style>
